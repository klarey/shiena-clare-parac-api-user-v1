<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="get-users-subflow" doc:id="db5d4cb3-ac8a-4456-8e89-cabe56441f1f" >
		<json-logger:logger doc:name="Log Start" doc:id="f5365738-fa24-44b6-8c8c-d13ef2e27f5b" config-ref="JSON_Logger_Config" message='#["get-users-flow - START"]' priority="DEBUG" category='#["esb.api-user-v1.get-users.start"]'/>
		<ee:transform doc:name="Set Variables output and query" doc:id="5fc9d65b-1aaf-4888-995d-be2532190708" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="query" ><![CDATA[%dw 2.0
output application/java
---
p('db.select_all_users_query')]]></ee:set-variable>
				<ee:set-variable variableName="output" ><![CDATA[%dw 2.0
output application/json
---
[]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Invoke Select from DB Subflow" doc:id="ba9073be-cf9b-4ab0-9a49-0a1fc6206185" name="select-from-db-subflow"/>
		<choice doc:name="Choice" doc:id="5f988d07-0ed5-420a-8933-f8f5017fff1c" >
			<when expression="#[sizeOf(payload) != 0]" >
				<foreach doc:name="For Each user" doc:id="38449e70-73c5-49f3-8a32-764639ede333" collection="#[payload]" >
					<choice doc:name="Choice" doc:id="f8f9e0a3-d4ee-4df1-9891-8f5930c2d567" >
						<when expression="#[payload.active == true]" >
							<ee:transform doc:name="Set payload for active account and append to output variable" doc:id="47c1f78e-0048-4fe9-b89d-730319a200ee" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable resource="mappings/get-users-set-payload-for-active-account.dwl" variableName="output" />
								</ee:variables>
							</ee:transform>
						</when>
						<otherwise >
							<json-logger:logger doc:name="Log User is not Active" doc:id="91b42c92-42b6-483a-9685-eb7611cc1fd6" config-ref="JSON_Logger_Config" message='#["User with userId " ++ payload.userId ++ " is not Active"]' tracePoint="EXCEPTION" priority="DEBUG" category='#["esb.api-user-v1.get-users-subflow.log-user-is-not-active"]'/>
							<ee:transform doc:name="Set payload for inactive account and append to output variable" doc:id="202da201-8107-4551-ae7d-4c0d06486e8a" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="output" ><![CDATA[%dw 2.0
output application/java
---
users:(vars."output".users default[]) ++ ([])]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
						</otherwise>
					</choice>
				</foreach>
			</when>
			<otherwise >
				<raise-error doc:name="Raise No User Retrieved from DB Error" doc:id="889cdfdd-7dc5-461f-a880-09ea7cb970ed" type="USER:NOT_FOUND" description="No user retrieved from DB" />
			</otherwise>
		</choice>
		<choice doc:name="Choice" doc:id="c9bfe02b-3614-4941-835a-6f47bd86bc1c" >
			<when expression='#[sizeOf(vars."output".users) != 0]' >
				<ee:transform doc:name="Set Response Payload" doc:id="71a3eff8-8757-498e-8fde-27a501906ea6" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars."output"]]></ee:set-payload>
						<ee:set-attributes ><![CDATA[%dw 2.0
output application/java
---
{
	statusCode: "200"
}]]></ee:set-attributes>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<raise-error doc:name="Raise No active user retrieved from DB Error" doc:id="e52f047d-9e3d-42bd-b9c0-af34dc75e0d4" type="USER:NOT_FOUND" description="No active user retrieved from DB" />
			</otherwise>
		</choice>
		<json-logger:logger doc:name="Log End" doc:id="4b5bfbd0-6e7d-472a-be6b-2296df3a95d0" config-ref="JSON_Logger_Config" message='#["get-users-flow - END"]' priority="DEBUG" category='#["esb.api-user-v1.get-users.end"]'/>
	</sub-flow>
</mule>
