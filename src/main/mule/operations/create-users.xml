<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="create-users-subflow" doc:id="5effec11-20ba-460e-be6c-e1d5781fd5fc" >
		<json-logger:logger doc:name="Log Start" doc:id="6d9d711c-3f5a-4b0d-bf1d-c005656f878e" config-ref="JSON_Logger_Config" message='#["create-user-flow - START"]' priority="DEBUG" category='#["esb.api-user-v1.create-users.start"]'/>
		<async doc:name="Async" doc:id="fa984ece-7f71-4f88-952a-cfa8f94824ea">
			<parallel-foreach doc:name="Parallel For Each" doc:id="e5de018c-9a94-487d-b2bb-1308a7019200" collection="#[payload.users]">
				<try doc:name="Try" doc:id="f893cc7f-27fc-4f88-8452-4c4512ae5d94">
					<json-logger:logger doc:name="Log Start of Insert into Account and UserDetails" doc:id="717c9575-9b8f-4e30-bfbc-d1ebac309c73" config-ref="JSON_Logger_Config" message='#["Insert into Account and UserDetails - START"]' tracePoint="BEFORE_REQUEST" priority="DEBUG" category='#["esb.api-user-v1.create-users-subflow.db.request"]' />
					<db:stored-procedure doc:name="Insert into Account and UserDetails Tables" doc:id="5f52e63b-1369-4817-bde7-24954a6cf41f" config-ref="Database_Config">
						<db:sql><![CDATA[#[p('db.create_users_query')]]]></db:sql>
						<db:input-parameters><![CDATA[#[{
	username: payload.'username',
	date_registered: payload.'dateRegistered',
	fullname: payload.'fullname',
	birthday: payload.'birthday',
	gender: if (upper(payload.gender) == "MALE") "M"
			else if (upper(payload.gender) == "FEMALE") "F"
			else ""
}]]]></db:input-parameters>
					</db:stored-procedure>
					<json-logger:logger doc:name="Log End of Insert into Account and UserDetails" doc:id="933a0769-6e89-4e89-879e-67fb281ad425" config-ref="JSON_Logger_Config" message='#["Insert into Account and UserDetails - END"]' tracePoint="AFTER_REQUEST" priority="DEBUG" category='#["esb.api-user-v1.create-users-subflow.db.response"]' />
					<error-handler>
						<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="9ab76e56-9f9f-416a-b6e7-335a2be94595" type="ANY">
							<json-logger:logger doc:name="Log Exception" doc:id="b1e80bec-5663-4c00-904e-2751fc0f4afa" config-ref="JSON_Logger_Config" message="#['Error encountered when writing to DB: ' ++ error.detailedDescription]" tracePoint="EXCEPTION" priority="ERROR" category='#["esb.api-user-v1.create-users-subflow.log-exception.error"]' />
						</on-error-continue>
					</error-handler>
				</try>
			</parallel-foreach>
		</async>
		<ee:transform doc:name="Set Response Payload" doc:id="5c755810-5bb0-4df3-8a6f-1ed6b0a2d434" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"message": "Success",
	"responseCode": "201"
}]]></ee:set-payload>
				<ee:set-attributes ><![CDATA[%dw 2.0
output application/java
---
{
	statusCode: "200"
}]]></ee:set-attributes>
			</ee:message>
		</ee:transform>
		<json-logger:logger doc:name="Log End" doc:id="cceb9b80-5ea7-4cbc-a79f-0bb21cac540d" config-ref="JSON_Logger_Config" message='#["create-user-flow - END"]' tracePoint="END" priority="DEBUG" category='#["esb.api-user-v1.create-users.end"]'/>
	</sub-flow>
</mule>
