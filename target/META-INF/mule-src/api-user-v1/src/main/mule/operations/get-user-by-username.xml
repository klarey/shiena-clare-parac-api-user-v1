<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="get-user-by-username-subflow" doc:id="a61ca185-9323-4427-8851-0ba3a6a2ba9d" >
		<json-logger:logger doc:name="Log Start" doc:id="5142380c-7d7f-4407-9b76-62e0524d0467" config-ref="JSON_Logger_Config" message='#["get-user-by-username-flow - START"]' priority="DEBUG" category='#["esb.api-user-v1.get-user-by-username.start"]'/>
		<ee:transform doc:name="Set Variables output and query" doc:id="bb51683b-97f9-40d1-b8b8-8181e92da003">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="query"><![CDATA[%dw 2.0
output application/java
---
p('db.select_specific_user_query')]]></ee:set-variable>
				<ee:set-variable variableName="output"><![CDATA[%dw 2.0
output application/json
---
{}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Invoke Select from DB Subflow" doc:id="fcf1a9be-af8f-47d5-bf7d-ee1b4dbadab4" name="select-from-db-subflow"/>
		<choice doc:name="Choice" doc:id="23f90e01-5e0f-4ddf-b389-920d4fa5bbb3" >
			<when expression="#[sizeOf(payload) != 0]" >
				<choice doc:name="Choice" doc:id="73e960bc-1ad8-4b5f-b375-610dc4c164cd">
					<when expression="#[payload.active[0] == true]">
						<ee:transform doc:name="Set payload and append to output variable" doc:id="afdf06eb-3f12-425e-babd-dc779e7460c0">
						<ee:message>
						</ee:message>
						<ee:variables >
								<ee:set-variable resource="mappings/get-user-by-username-set-payload-for-active-account.dwl" variableName="output" />
							</ee:variables>
					</ee:transform>
					</when>
					<otherwise >
						<raise-error doc:name="Raise User is inactive Error" doc:id="40646491-692e-4565-abce-ee63ff47a387" type="USER:INACTIVE" description="User is inactive" />
					</otherwise>
				</choice>
			</when>
			<otherwise >
				<raise-error doc:name="Raise User not found Error" doc:id="f3cc0922-90ab-4b31-af02-2c6a874777f9" type="USER:NOT_FOUND" description="User with the given username does not exist" />
			</otherwise>
		</choice>
		<ee:transform doc:name="Set Response Payload" doc:id="3e8f8fb6-1bd3-4020-be7c-867ab5fe9b00" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars."output"]]></ee:set-payload>
				<ee:set-attributes ><![CDATA[%dw 2.0
output application/java
---
{
	statusCode: "200"
}]]></ee:set-attributes>
			</ee:message>
		</ee:transform>
		<json-logger:logger doc:name="Log End" doc:id="7106ce9d-44e7-4048-bfb3-09e10623ff95" config-ref="JSON_Logger_Config" message='#["get-user-by-username-flow - END"]' tracePoint="END" priority="DEBUG" category='#["esb.api-user-v1.get-user-by-username.end"]'/>
	</sub-flow>
</mule>
