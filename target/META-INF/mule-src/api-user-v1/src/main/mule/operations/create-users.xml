<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="create-users-subflow" doc:id="5effec11-20ba-460e-be6c-e1d5781fd5fc" >
		<json-logger:logger doc:name="Log Start" doc:id="6d9d711c-3f5a-4b0d-bf1d-c005656f878e" config-ref="JSON_Logger_Config" message='#["create-user-flow - START"]' />
		<flow-ref doc:name="Invoke Validate Header Flow" doc:id="307cdab8-92db-4865-abca-9ddbc530d4d6" name="validate-header-subflow" />
		<choice doc:name="Choice" doc:id="60437a37-b4e3-40da-b67e-9a006e71d61a" >
			<when expression="#[sizeOf(payload.users) != 0]" >
				<async doc:name="Async" doc:id="36787908-7255-498f-9dfa-eb2cbcbb1734" >
					<foreach doc:name="For Each" doc:id="7600283c-8b4a-42a9-87a1-89229715641d" collection="#[payload.users]" >
						<try doc:name="Try" doc:id="e5c36f82-3478-4120-80f7-25ff8ac87cf9" >
							<json-logger:logger doc:name="Log Start of Insert into Account and UserDetails" doc:id="c23b6107-98d9-438c-a4e8-09d38a39b6c0" config-ref="JSON_Logger_Config" message='#["Insert into Account and UserDetails - START"]'/>
							<db:stored-procedure doc:name="Insert into Account and UserDetails Tables" doc:id="31015bd2-d9e3-4a1b-bf8a-9fe0f511cea5" config-ref="Database_Config">
								<db:sql ><![CDATA[call insert_into_Account_and_UserDetails(UUID_TO_BIN(UUID()), UUID_TO_BIN(UUID()), :userId, :fullname, :birthday, :gender,
 :username, 1, :date_registered)]]></db:sql>
								<db:input-parameters ><![CDATA[#[{
	username: payload.'username',
	date_registered: payload.'dateRegistered',
	userId: uuid(),
	fullname: payload.'fullname',
	birthday: payload.'birthday',
	gender: if (upper(payload.gender) == "MALE") "M"
			else if (upper(payload.gender) == "FEMALE") "F"
			else ""
}]]]></db:input-parameters>
							</db:stored-procedure>
							<json-logger:logger doc:name="Log End of Insert into Account and UserDetails" doc:id="a24d5237-8e76-477b-a165-8519b7d0e085" config-ref="JSON_Logger_Config" message='#["Insert into Account and UserDetails - END"]' />
							<error-handler >
								<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a6e44045-872c-46c2-b9c7-726af384cfd6" type="ANY" >
									<json-logger:logger doc:name="Log Exception" doc:id="bcbd5f62-a5b4-431d-b998-a858a4c01bd1" config-ref="JSON_Logger_Config" message="#['Error encountered when writing to DB: ' ++ error.detailedDescription]" tracePoint="EXCEPTION" priority="ERROR" />
								</on-error-continue>
							</error-handler>
						</try>
					</foreach>
				</async>
			</when>
			<otherwise >
				<raise-error doc:name="Raise User Details not found Error" doc:id="cad7262d-6dfc-4501-b434-4eec99fda174" type="USER:DETAILS_NOT_FOUND" description="User details not found" />
			</otherwise>
		</choice>
		<ee:transform doc:name="Set Response Payload" doc:id="5c755810-5bb0-4df3-8a6f-1ed6b0a2d434" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"message": "Success",
	"responseCode": "201"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<json-logger:logger doc:name="Log End" doc:id="cceb9b80-5ea7-4cbc-a79f-0bb21cac540d" config-ref="JSON_Logger_Config" message='#["create-user-flow - END"]' />
	</sub-flow>
</mule>
